let recognition;
let finalTranscript = '';  // Persistent across restarts
let isRestarting = false;  // Track auto-restarts

function startRecordingQuestion() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.interimResults = true;
    recognition.lang = 'en-US';

    recognition.onresult = (event) => {
        let interimTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
            if (event.results[i].isFinal) {
                finalTranscript += event.results[i][0].transcript + ' ';
            } else {
                interimTranscript += event.results[i][0].transcript;
            }
        }
        document.getElementById('responseText').value = finalTranscript + interimTranscript;
    };

    recognition.onend = () => {
        if (isRestarting) {
            return;  // Prevent recursive restarts
        }
        // Auto-restart after pause
        isRestarting = true;
        setTimeout(() => {
            if (recognition) {
                startRecordingQuestion();
                isRestarting = false;
            }
        }, 500);  // Short delay before restarting
    };

    recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        if (event.error === 'no-speech' || event.error === 'aborted') {
            // Normal pauses may trigger 'no-speech' so we handle it gently
            recognition.stop();  // Ensure clean restart
            setTimeout(() => startRecordingQuestion(), 500);
        } else {
            alert('Speech recognition error: ' + event.error);
        }
    };

    recognition.start();
}

function stopRecordingQuestion() {
    if (recognition) {
        recognition.stop();
    }
}
